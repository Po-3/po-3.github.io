/* ==========================================================
   Apple OS Widget - Workers RSS 取得版（軽量 / バッチ更新）
   - RSS取得先：Cloudflare Workers（CORS回避済み）
   - 初期表示：--（プレースホルダー）
   - DOM更新：requestAnimationFrameで一括反映（体感の揺れ防止）
   ========================================================== */
(function(){
  "use strict";

  var RSS_URL = "https://apple-os-rss-proxy.7xjvnhs9mz.workers.dev/";
  var BETA_RE = /\b(beta|rc|developer beta|public beta)\b/i;

  var OS_KEYS = [
    { key: "iOS",      id: "ios" },
    { key: "iPadOS",   id: "ipados" },
    { key: "macOS",    id: "macos" },
    { key: "watchOS",  id: "watchos" },
    { key: "tvOS",     id: "tvos" },
    { key: "visionOS", id: "visionos" },
    { key: "audioOS",  id: "audioos" }
  ];

  var DOM_IDS = [
    { os:"ios",      stable:"os-ios-stable",      beta:"os-ios-beta" },
    { os:"ipados",   stable:"os-ipados-stable",   beta:"os-ipados-beta" },
    { os:"macos",    stable:"os-macos-stable",    beta:"os-macos-beta" },
    { os:"watchos",  stable:"os-watchos-stable",  beta:"os-watchos-beta" },
    { os:"tvos",     stable:"os-tvos-stable",     beta:"os-tvos-beta" },
    { os:"audioos",  stable:"os-audioos-stable",  beta:"os-audioos-beta" },
    { os:"visionos", stable:"os-visionos-stable", beta:"os-visionos-beta" }
  ];

  var CACHE_KEY = "tnr_os_widget_cache_v1";
  var CACHE_TTL_MS = 6 * 60 * 60 * 1000; // 6h
  var FETCH_TIMEOUT_MS = 3500;

  function $(id){ return document.getElementById(id); }
  function safeText(el, v){ if(el) el.textContent = v; }
  function now(){ return Date.now ? Date.now() : new Date().getTime(); }

  function readCache(){
    try{
      var raw = localStorage.getItem(CACHE_KEY);
      if(!raw) return null;
      var obj = JSON.parse(raw);
      if(!obj || !obj.savedAt || !obj.data) return null;
      if(now() - obj.savedAt > CACHE_TTL_MS) return null;
      return obj.data;
    }catch(e){ return null; }
  }
  function writeCache(data){
    try{
      localStorage.setItem(CACHE_KEY, JSON.stringify({ savedAt: now(), data: data }));
    }catch(e){}
  }

  function extractVersionPart(title, osKey){
    // "iOS 26.3 beta 2 (23D5033l)" -> "26.3 beta 2"
    // "(...)" はそもそも拾わない
    var re = new RegExp(osKey + "\\s+([0-9]+(?:\\.[0-9]+){0,2}(?:\\s+(?:beta\\s*\\d+|RC))?)","i");
    var m = title.match(re);
    if(!m) return null;
    return String(m[1]||"").replace(/\s+/g," ").trim() || null;
  }

  function normalizeBeta(stable, beta){
    if(!beta) return "-";
    if(!stable) return beta;
    if(/\b(beta|rc)\b/i.test(beta)) return beta;
    if(String(stable).trim().toLowerCase() === String(beta).trim().toLowerCase()) return "-";
    return beta;
  }

  function parseRSS(xmlText){
    var parser = new DOMParser();
    var xml = parser.parseFromString(xmlText, "application/xml");
    if(xml.getElementsByTagName("parsererror").length) throw new Error("parse error");
    return xml;
  }

  function getItems(xml){
    var items = xml.getElementsByTagName("item");
    var out = [];
    for(var i=0;i<items.length;i++){
      var it = items[i];
      var t = it.getElementsByTagName("title")[0];
      var p = it.getElementsByTagName("pubDate")[0];
      out.push({
        title: t ? t.textContent : "",
        pubDate: p ? new Date(p.textContent) : null
      });
    }
    return out;
  }

  function sortNewest(items){
    return items.slice().sort(function(a,b){
      var at = a.pubDate && !isNaN(a.pubDate.getTime()) ? a.pubDate.getTime() : 0;
      var bt = b.pubDate && !isNaN(b.pubDate.getTime()) ? b.pubDate.getTime() : 0;
      return bt - at;
    });
  }

  function pickLatest(items){
    var res = {
      ios:{stable:null,beta:null},
      ipados:{stable:null,beta:null},
      macos:{stable:null,beta:null},
      watchos:{stable:null,beta:null},
      tvos:{stable:null,beta:null},
      audioos:{stable:null,beta:null},
      visionos:{stable:null,beta:null},
      updated:null
    };
    if(items[0] && items[0].pubDate && !isNaN(items[0].pubDate.getTime())){
      res.updated = items[0].pubDate.toISOString();
    }

    for(var i=0;i<items.length;i++){
      var title = (items[i].title||"").trim();
      if(!title) continue;

      var isBeta = BETA_RE.test(title);

      for(var k=0;k<OS_KEYS.length;k++){
        var osKey = OS_KEYS[k].key;
        var osId  = OS_KEYS[k].id;
        if(title.indexOf(osKey) === -1) continue;

        var ver = extractVersionPart(title, osKey);
        if(!ver) continue;

        if(isBeta){
          if(!res[osId].beta) res[osId].beta = ver;
        }else{
          if(!res[osId].stable) res[osId].stable = ver;
        }
      }
    }
    return res;
  }

  function applyToDOM(data){
    requestAnimationFrame(function(){
      for(var i=0;i<DOM_IDS.length;i++){
        var os = DOM_IDS[i].os;
        var stableEl = $(DOM_IDS[i].stable);
        var betaEl   = $(DOM_IDS[i].beta);

        var stable = (data[os] && data[os].stable) ? data[os].stable : "--";
        var betaRaw = (data[os] && data[os].beta) ? data[os].beta : null;
        var beta = normalizeBeta(stable !== "--" ? stable : null, betaRaw);
        if(!beta) beta = "--";

        safeText(stableEl, stable);
        safeText(betaEl, beta);
      }

      if(data.updated){
        var d = new Date(data.updated);
        if(!isNaN(d.getTime())){
          var y = d.getFullYear();
          var m = String(d.getMonth()+1).padStart(2,"0");
          var dd= String(d.getDate()).padStart(2,"0");
          safeText($("os-updated"), y + "-" + m + "-" + dd);
        }
      }
    });
  }

  function fetchWithTimeout(url, timeoutMs){
    var controller = (typeof AbortController !== "undefined") ? new AbortController() : null;
    var timer = null;

    if(controller){
      timer = setTimeout(function(){ try{ controller.abort(); }catch(e){} }, timeoutMs);
    }

    return fetch(url, {
      cache: "no-store",
      signal: controller ? controller.signal : undefined
    }).then(function(res){
      if(timer) clearTimeout(timer);
      if(!res.ok) throw new Error("HTTP " + res.status);
      return res.text();
    });
  }

  function run(){
    // 1) cache即反映（体感速度UP）
    var cached = readCache();
    if(cached) applyToDOM(cached);

    // 2) fresh取得 → 1バッチ反映
    fetchWithTimeout(RSS_URL, FETCH_TIMEOUT_MS)
      .then(parseRSS)
      .then(getItems)
      .then(sortNewest)
      .then(pickLatest)
      .then(function(fresh){
        // 取れた形跡がない場合は上書きしない
        var any =
          (fresh.ios.stable || fresh.ios.beta) ||
          (fresh.ipados.stable || fresh.ipados.beta) ||
          (fresh.macos.stable || fresh.macos.beta) ||
          (fresh.watchos.stable || fresh.watchos.beta) ||
          (fresh.tvos.stable || fresh.tvos.beta) ||
          (fresh.audioos.stable || fresh.audioos.beta) ||
          (fresh.visionos.stable || fresh.visionos.beta);

        if(!any) return;

        writeCache(fresh);
        applyToDOM(fresh);
      })
      .catch(function(){
        // 失敗時：cacheがあればそれが出る。なければ--のまま（レイアウト不変）
      });
  }

  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", run);
  }else{
    run();
  }
})();